---
title: "MMSE score prediction"
author: "Luiz Felipe Martucci"
date: "2023-01-31"
output:
  html_document: default
  pdf_document: default
---

```{r setup, message=FALSE, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libs, message=FALSE, warning=FALSE, include=FALSE}
(\(x){
  sapply(x, function(x) if(!x %in% installed.packages()){
    install.packages(x, dependencies = T)
  })
  sapply(x, library, character.only=T)
})(c("tidyverse", "gt", "caret", "doParallel", "glmnet", "pROC", "kernlab", "naivebayes"))


```

```{r fns, message=FALSE, warning=FALSE, include=FALSE}

filter_vec <- function(exp, .data = NULL){
  index <- exp
  vec <- as.character(substitute(exp))[2]
  vec <- substitute(vec)
  vec <- eval(parse(text = vec))
  if(is.null(.data)){
  vec[index]
  }else{
    .data[index]
  }
}


Bar_plot_theme <- function(){
  
  font <- "Arial"
  
  
  theme(
    #plot.margin = margin(16, 16, 16, 16),
    #legend.position = "top",
    plot.title = ggplot2::element_text(family = font, 
                                       size = 16, 
                                       face = "bold",
                                       color = "#222222"),
    plot.subtitle = ggplot2::element_text(family = font, 
                                          size = 22,
                                          margin = ggplot2::margin(9, 0, 9, 0)), 
    legend.text.align = 0,
    legend.background = ggplot2::element_blank(),
    legend.title = ggplot2::element_blank(),
    legend.key = ggplot2::element_blank(),
    axis.title.x = ggplot2::element_blank(),
    axis.title.y = ggplot2::element_text(
      color = "#222222",
      size = 11,
      margin = margin(5, r = 10)
    ),
    axis.text = ggplot2::element_text(
      family = font,
      size = 11,
      color = "#222222"
    ),
    axis.text.x        = ggplot2::element_text(margin = ggplot2::margin(5, b = 10)),
    axis.ticks         = ggplot2::element_line(color = "#222222"),
    axis.line          = ggplot2::element_line(color = "#222222"),
    panel.grid.minor   = ggplot2::element_blank(),
    panel.grid.major.y = ggplot2::element_blank(),
    panel.grid.major.x = ggplot2::element_blank(),
    panel.background   = ggplot2::element_blank(),
    plot.background    = ggplot2::element_blank(),
    strip.background   = ggplot2::element_rect(fill = "white"),
    #strip.text = ggplot2::element_text(size = 22, hjust = 0),
    aspect.ratio       = 1.21
  )
}

```


# Introduction

This project aims to predict if an elderly has fallen in the past six months by using information about his gait pattern.

The data used in this project is from the work of Noh, B., Youm, C., Goh, E., et al. (2021), published in Nature Scientific Reports. The dataset contains 746 observations, and the target variable "History of Falls" is highly unbalanced.




```{r data, message=FALSE, warning=FALSE, include=FALSE}

df_full <- (\(){
  d1 <- readxl::read_excel("41598_2021_91797_MOESM1_ESM.xlsx", 
    skip = 1) %>% 
  mutate(Number = as.numeric(Number)) %>% 
  filter(!is.na(Number))

d2 <-  readxl::read_excel("41598_2021_91797_MOESM1_ESM.xlsx", 
    sheet = "Environmental characteristics", 
    skip = 1) 

  
data <- left_join(d1, d2) %>% 
  select(-c(`education year`, Fear_of_fall, `Fall risk`)) 


#Correcting variable type
d_adj <- data %>% mutate(across(where(is.numeric), ~ if(max(.) <= 5) factor(.)))

# Some variables where incorrectly selected
index <- grepl("time|speed|length", colnames(d_adj))
correct_vars <- colnames(d_adj)[!index]


d_adj <- d_adj %>%
  select(all_of(correct_vars)) %>% 
  cbind(Number = data$Number)


data <- data %>% select(-all_of(correct_vars)) %>% 
  left_join(d_adj, by="Number")

return(data)

  
})()
plots <- list()
#scales::breaks_pretty()
plots$p1 <- df_full %>% 
  mutate(History_of_fall = ifelse(History_of_fall == 0, "No", "Yes")) %>% 
  ggplot(aes(History_of_fall, fill= History_of_fall)) +
  geom_bar(show.legend = FALSE)+
  ylab("History of falls") +
  scale_fill_manual(values = c("#00589B", "#C43362")) +
  scale_y_continuous(expand = c(0, NA),
                     limits = c(NA, NA))+
  Bar_plot_theme()+
  ggtitle("Distribution of history of falls observations")


plots$p1
```

```{r echo=FALSE}
plots$p1
```



# References 
Noh, B., Youm, C., Goh, E., et al. XGBoost-based machine learning approach to predict the risk of fall in older adults using gait outcomes. Sci Rep 11, 12183 (2021). https://doi.org/10.1038/s41598-021-91797-w

